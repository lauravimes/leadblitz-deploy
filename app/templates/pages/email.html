{% extends "base.html" %}
{% block title %}Email — LeadBlitz{% endblock %}

{% block content %}
<div class="section-header">
  <h1>Email outreach</h1>
</div>

{% if is_bulk and bulk_leads %}
{# ───── BULK / MAIL-MERGE MODE ───── #}
{% set leads_with_email = bulk_leads | selectattr('email') | list %}
{% set leads_no_email   = bulk_leads | rejectattr('email') | list %}
{% set leads_with_score = bulk_leads | selectattr('score') | list %}
{% set leads_no_score   = bulk_leads | rejectattr('score') | list %}

<div class="merge-info">
  <h3>Mail merge: {{ bulk_leads | length }} lead{{ 's' if bulk_leads | length != 1 }}{% if attach_report %} with audit report attached{% endif %}</h3>
  <div class="merge-stats">
    <span>{{ leads_with_email | length }} with email</span>
    {% if leads_no_email %}<span>{{ leads_no_email | length }} missing email (skipped)</span>{% endif %}
    {% if attach_report %}
    <span>{{ leads_with_score | length }} with score (report ready)</span>
    {% if leads_no_score %}<span>{{ leads_no_score | length }} without score (no report)</span>{% endif %}
    {% endif %}
  </div>
  <details>
    <summary>View all {{ bulk_leads | length }} leads</summary>
    <div class="merge-lead-list">
      {% for lead in bulk_leads %}
      <div class="merge-lead-item">
        <span style="flex:1;font-weight:500">{{ lead.name }}</span>
        <span>{{ lead.email or 'No email' }}</span>
        {% if attach_report %}
        <span>{{ 'Score: ' ~ lead.score if lead.score is not none else 'No score' }}</span>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
</div>

<div class="card">
  <h2>Compose</h2>
  <form id="email-form" style="margin-top:16px">
    {% if attach_report %}
    <input type="hidden" name="attach_report" value="1">
    {% endif %}
    <input type="hidden" name="lead_ids" id="email-lead-ids"
           value="{{ bulk_leads | map(attribute='id') | join(',') }}">
    <div class="form-group">
      <label>Subject (use {{business_name}} and {{website}} as variables)</label>
      <input type="text" name="subject" id="email-subject"
             value="Website Audit Report — {% raw %}{{business_name}}{% endraw %}">
    </div>
    <div class="form-group">
      <label>Body (HTML supported, variables will be replaced per lead)</label>
      <textarea name="body" id="email-body" rows="8">Hi,

I took a look at your website and put together a quick audit report with some findings that I think you'll find useful.

I've attached the full report as a PDF — it covers page speed, mobile-friendliness, SEO, and security.

Happy to chat if you'd like to discuss any of it.

Best regards</textarea>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button type="button" class="btn btn-secondary btn-sm"
              hx-post="/api/email/preview"
              hx-include="#email-form"
              hx-target="#email-preview">Preview</button>
      <button type="button" class="btn btn-primary btn-sm"
              hx-post="/api/email/send"
              hx-include="#email-form"
              hx-target="#email-status"
              hx-confirm="Send mail merge to {{ leads_with_email | length }} lead{{ 's' if leads_with_email | length != 1 }}?">Send</button>
    </div>
    <div id="email-status" style="margin-top:12px"></div>
  </form>
</div>

{% else %}
{# ───── SINGLE / EMPTY COMPOSE MODE ───── #}
<div class="card">
  <h2>Compose</h2>
  {% if attach_report and prefill_lead %}
  <div style="margin-top:12px;padding:10px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-size:14px">
    Audit report for <strong>{{ prefill_lead.name }}</strong> will be attached as PDF
  </div>
  {% endif %}
  <form id="email-form" style="margin-top:16px">
    {% if attach_report and prefill_lead %}
    <input type="hidden" name="attach_report" value="1">
    {% endif %}
    <div class="form-group">
      <label>Subject</label>
      <input type="text" name="subject" id="email-subject"
             placeholder="Hi {{business_name}} — quick question"
             value="{% if prefill_lead %}Website Audit Report — {{ prefill_lead.name }}{% endif %}">
    </div>
    <div class="form-group">
      <label>Body (HTML supported, use {{business_name}} and {{website}} as variables)</label>
      <textarea name="body" id="email-body" rows="8" placeholder="Write your email...">{% if prefill_lead %}Hi,

I took a look at your website and put together a quick audit report with some findings that I think you'll find useful.

I've attached the full report as a PDF — it covers page speed, mobile-friendliness, SEO, and security.

Happy to chat if you'd like to discuss any of it.

Best regards{% endif %}</textarea>
    </div>
    <div class="form-group">
      <label>Lead IDs (comma separated)</label>
      <input type="text" name="lead_ids" id="email-lead-ids"
             placeholder="Select leads from the Leads page"
             value="{% if prefill_lead %}{{ prefill_lead.id }}{% endif %}">
    </div>
    {% if prefill_lead %}
    <div style="display:flex;gap:8px;align-items:center">
      <button type="button" class="btn btn-secondary btn-sm"
              hx-post="/api/email/personalize"
              hx-vals='{"lead_id":"{{ prefill_lead.id }}"}'
              hx-target="#ai-fill-status"
              hx-indicator="#ai-fill-status"
              onclick="this.disabled=true;this.textContent='Generating...'">AI-write email</button>
      <span id="ai-fill-status" class="subtext"></span>
    </div>
    <script>
    document.body.addEventListener('htmx:afterRequest', function(e){
      if(e.detail.pathInfo && e.detail.pathInfo.requestPath==='/api/email/personalize'){
        var btn=document.querySelector('[hx-post="/api/email/personalize"]');
        if(btn){btn.disabled=false;btn.textContent='AI-write email';}
        try{
          var d=JSON.parse(e.detail.xhr.responseText);
          if(d.subject)document.getElementById('email-subject').value=d.subject;
          if(d.body)document.getElementById('email-body').value=d.body;
          document.getElementById('ai-fill-status').innerHTML='<span class="saved-flash">Done</span>';
        }catch(err){
          document.getElementById('ai-fill-status').innerHTML='<span class="error-msg">Failed</span>';
        }
      }
    });
    </script>
    {% endif %}
    <div style="display:flex;gap:8px;margin-top:12px">
      <button type="button" class="btn btn-secondary btn-sm"
              hx-post="/api/email/preview"
              hx-include="#email-form"
              hx-target="#email-preview">Preview</button>
      <button type="button" class="btn btn-primary btn-sm"
              hx-post="/api/email/send"
              hx-include="#email-form"
              hx-target="#email-status"
              hx-confirm="Send email to selected leads?">Send</button>
    </div>
    <span id="email-status" style="margin-left:12px"></span>
  </form>
</div>
{% endif %}

<div id="email-preview" style="margin-top:16px"></div>

<div class="card" style="margin-top:32px">
  <h2>Signature</h2>
  <form hx-post="/api/email/signatures" hx-target="#sig-status" hx-swap="innerHTML" style="margin-top:16px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" name="full_name">
      </div>
      <div class="form-group">
        <label>Position</label>
        <input type="text" name="position">
      </div>
    </div>
    <div class="form-group">
      <label>Company Name</label>
      <input type="text" name="company_name">
    </div>
    <div class="form-group">
      <label>Base Pitch (used for AI personalization)</label>
      <textarea name="base_pitch" rows="3" placeholder="We help local businesses get more customers through modern websites..."></textarea>
    </div>
    <button type="submit" class="btn btn-primary btn-sm">Save signature</button>
    <span id="sig-status" style="margin-left:12px"></span>
  </form>
</div>

<div class="card" style="margin-top:32px">
  <div class="section-header">
    <h2>Saved templates</h2>
  </div>
  <div id="template-list" hx-get="/api/email/templates" hx-trigger="load" hx-swap="innerHTML">
    <span class="htmx-indicator">Loading...</span>
  </div>
</div>
{% endblock %}
